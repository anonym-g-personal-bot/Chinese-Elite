# .github/workflows/pr_auto_merger.yml

name: 自动验证并合并数据类 PR (Auto-Validate and Merge Data PRs)

on:
  schedule:
    # 每天的 16 点 0 分执行 (UTC 时间)
    - cron: '0 16 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-validate-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码 (Checkout Code)
        uses: actions/checkout@v4

      - name: 设置 Python (Set up Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: 安装项目依赖 (Install Dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 验证并合并 PR (Validate and Merge PRs)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
        run: |
          echo "开始智能验证流程..."
          merged_count=0
          max_merges=10

          pr_numbers=$(gh pr list --state open --json number --jq '.[].number')
          if [ -z "$pr_numbers" ]; then
            echo "没有待处理的 PR。"
            exit 0
          fi
          
          for pr_number in $pr_numbers; do
            if [ "$merged_count" -ge "$max_merges" ]; then
              echo "已达到本次运行的合并上限 (10)，流程结束。"
              break
            fi

            echo "--- 正在检查 PR #${pr_number} ---"
            
            files_changed=$(gh pr diff $pr_number --name-only)
            file_count=$(echo "$files_changed" | wc -l)
            other_files=$(echo "$files_changed" | grep -vE '^(docs/master_graph_qcode.json|data/LIST.txt)$')

            if [ -n "$other_files" ] || [ "$file_count" -ne 1 ]; then
              echo "PR #${pr_number} 修改了不允许的文件或修改了多个文件，已跳过。"
              continue
            fi

            echo "文件路径检查通过。正在调用 Python 脚本进行评估..."
            
            python scripts/validate_pr.py $pr_number
            exit_code=$?

            if [ $exit_code -eq 0 ]; then
              echo "✅ 评估结果：有意义。准备合并..."
              gh pr merge $pr_number --auto --squash --delete-branch
              merged_count=$((merged_count + 1))
            elif [ $exit_code -eq 1 ]; then
              echo "❌ 评估结果：无意义。正在关闭 PR 并留言..."
              comment_body="This Pull Request has been automatically closed because our AI reviewer determined the changes to be trivial or not meaningful. If you believe this is an error, please open a new PR with a more detailed explanation."
              gh pr comment $pr_number --body "$comment_body"
              gh pr close $pr_number
            else
              echo "⚠️ 评估脚本执行出错 (退出码: $exit_code)，已跳过此 PR。"
            fi
          done
